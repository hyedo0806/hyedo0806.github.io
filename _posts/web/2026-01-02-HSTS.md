---
title: HSTS
date: 2026-01-02 11:11:11 
categories: [web, k8s]
tags: [TAG]     # TAG names should always be lowercase
---

# HSTS
HTTP Strict-Transport-Security 는 브라우저에 해당 host에 HTTPS를 통해서만 접근해야하며, 향후 HTTP를 사용하여 접근하려는 모든 시도는 자동으로 HTTPS로 upgrade 되는 것을 알려준다. <br>
서버가 아래 헤더를 HTTPS 응답에 실어 보내면 브라우저가 기억하는 방식.<br>
```
Strict-Transport-Security: max-age=31536000
```

## option 
1. max-age<br>
브라우저가 HTTPS 강제를 기억하는 시간 (단위: 초)<br>

| value | 의미 |
|------|------|
| 0 | HSTS 즉시해제 |
| 86400 | 1일 |
| 31535000|1년 (운영 안정화)|


2. includeSubDomains<br>
모든 서브도메인까지 HTTPS 강제


3. preload<br>
브라우저에 영구 내장 요청

# 적용 방법

## 시스템 구성 
시스템은 k8s 환경에서 운영되며 web server와 api server가 독립된 pod로 구성되어 있다. <br>
web server는 nginx를 기반으로 vue로 개발된 정적 웹 애플리케이션을 제공한다. client 요청에 따라 api server로 rest API 호출을 수행하고 그 응답 결과를 화면에 렌더링한다.<br>
api server는 spring framework 기반 애플리케이션으로 구성되어 있으며, tomcat 컨테이너를 통해 구동된다.<br>
외부에서 유입되는 모든 트래픽을 k8s ingress(nginx ingress controller)를 통해 클러스터 내부로 라우팅된다. ingress 계층에서 TLS 종료 및 트래픽 제어를 수행한 후 web server pod로 전달된다. 

## ingress 설정
Ingress Controller의 ConfigMap data에 설정
```
apiVersion: v1
kind: ConfigMap
metadata:
  name: ingress-nginx-controller
  namespace: ingress-nginx
data:
  hsts: "true"
  hsts-max-age: "31536000"
  hsts-include-subdomains: "false"
  ```

# 헷갈렸던 점
## Ingress vs NGINX vs Ingress Controller

1. k8s ingress <br>
Ingress 자체는 트래픽을 처리하지 않음.
트래픽을 정의하는 규칙 문서이다. (예시:이 Host / Path로 들어오는 요청은
이 Service로 보내라)

2. Ingress-Nginx Controller<br>
ingress controller는 ingress 리소스를 감시하고 그걸 기반으로 실제 NGINX 설정 파일을 동적으로 생성한다. 내부에서 NGINX를 reload. 외부 트래픽이 들어오는 입구.

3. NGINX<br>
단독 nginx pod를 가리킴. 예를 들어 vue 웹서버 pod. 외부 트래픽을 직접 받지 않는다. ingress controller 뒤에 숨어 있는 내부 컴포넌트.

## ingress controller의 configmap VS nginx의 conf.d 파일
단독 nginx pod의 conf.d 파일을 configmap 형태로 들어간다. 애플리케이션 내부 웹서버 설정용. (정적 파일 서빙, SPA 라우팅, 백엔드 프록시 등) 

ingress controller의 configmap의 data는 TLS/HTTPS 정책, 보안헤더, 프록시헤더 처리 등 클러스터 외부 트래픽 정책. 