---
title: JWT
date: 2025-10-19 23:59:59
categories: [Spring Security]
tags: [security]     # TAG names should always be lowercase
---
# JWT 동작 흐름
1. **로그인**: /auth/login 에서 아이디/비번 검증 → AccessToken(JWT)(+선택: RefreshToken) 발급.

2. **클라이언트 보관**: 클라이언트가 AccessToken을 Authorization: Bearer <TOKEN> 로 저장/전송.

3. **요청 수신**: 서버의 JWT 필터가 매 요청마다 Authorization 헤더에서 토큰 추출.

4. **검증**: 서명 검증(시크릿/공개키), 만료(exp), 발급자(iss), audience, 권한(claims) 검사.

5. **인증객체 주입**: 유효하면 SecurityContext에 Authentication 저장 → 컨트롤러가 @AuthenticationPrincipal 등으로 사용자 접근 가능.

6. **인가(접근제어)**: hasRole, hasAuthority, URL별 permitAll()/authenticated() 로 보호.

7. **만료/무효**: 만료·조작·블랙리스트면 401(Unauthorized) 반환.

# SecurityFilterChain 설정
```
@Bean
SecurityFilterChain securityFilterChain(HttpSecurity http,
                                        JwtAuthenticationFilter jwtFilter) throws Exception {
    return http
      .csrf(csrf -> csrf.disable())                 // API는 보통 stateless
      .sessionManagement(sm -> sm.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
      .authorizeHttpRequests(auth -> auth
          .requestMatchers("/auth/**", "/health").permitAll() 
          .anyRequest().authenticated()   // /auth/** 같은 공개 엔트포인트 외에는 authenticated()으로 인증
      )
      .addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class)
      .exceptionHandling(ex -> ex
          .authenticationEntryPoint((req, res, e) -> {
              res.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
              res.setContentType("application/json");
              res.getWriter().write("{\"message\":\"Unauthorized\"}");
          })
      )
      .build();
}
```

# JwtAuthenticationFilter
Spring Security 기본 필터 체인에는 “JWT 전용 검증 필터”가 없기 때문에, 사용자가 직접 OncePerRequestFilter를 상속받아 구현해야한다.<br>
Spring Security의 기본 인증 흐름은 UsernamePasswordAuthenticationFilter를 기반으로
세션 로그인(폼 로그인)을 처리한다.<br>
하지만 JWT는 세션이 없고, 요청마다 Authorization 헤더에 토큰을 담아 인증하기 때문에
이를 해석·검증하는 커스텀 필터가 필요합니다.<br>
- 토큰 추출
- 유효성 검증
- SecurityContext에 인증 정보 주입
```
SecurityConfig
 └── JwtAuthenticationFilter  ← 우리가 직접 정의
      └── TokenProvider       ← JWT 생성/검증 로직
      └── UserDetailsService  ← username으로 사용자 정보 로드
```
